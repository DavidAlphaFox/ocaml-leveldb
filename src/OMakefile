
CFLAGS += -g -Wall -O2 -I../leveldb/include -fPIC

%.o: %.c
	$(OCAMLC) -cc g++ $(mapprefix -ccopt, $(CFLAGS)) -c $^

leveldb_stubs.o: leveldb_stubs.cc

LEVELDBLIB = $(file ../leveldb/libleveldb.a)

section
    leveldb.cma leveldb.a leveldb.cmxa libcamlleveldb.a: \
	leveldb_stubs.o levelDB.cmx levelDB.cmo $(LEVELDBLIB)
	ocamlmklib \
	    -ldopt -lleveldb \
	    -oc camlleveldb -o leveldb -L../leveldb \
	    -ltcmalloc -lsnappy leveldb_stubs.o levelDB.cmx levelDB.cmo
	section
	    private.TMPDIR = $(shell mktemp -d)
	    cd($(TMPDIR), $(shell ar x $(absname $(LEVELDBLIB))))
	    private.OBJECTS = $(glob $(TMPDIR)/*.o)
	    ar rs libcamlleveldb.a $(OBJECTS)
	    rm -rf $(TMPDIR)

toplevel: leveldb.cma libcamlleveldb.a
	ocamlmktop -cc g++ -ccopt -Wno-write-strings \
	    -o toplevel -cclib -L. unix.cma threads.cma leveldb.cma -thread

.DEFAULT: leveldb.cma leveldb.cmxa

.PHONY: clean

clean:
	rm -f $(filter-proper-targets $(ls R, .)) *.s *.annot *.so *.a
